<html>
  <head>
    <title>Caja Test Bed</title>

    <style type="text/css">
      form { display: inline }
      div.message                { margin: 2px 2px .5em 2px; padding-left: 4px }
      .message                   { border-left: 4px solid #000 }
      .message.WARNING,
      .message.CRITICAL_WARNING  { border-left: 4px solid #bb0 }
      .message.ERROR,
      .message.FATAL_ERROR       { border-left: 4px solid #800 }

      .problem                   { border: 1px dotted #000 }
      .WARNING          .problem,
      .CRITICAL_WARNING .problem { border: 1px dotted #880; background: #ffd }
      .ERROR            .problem,
      .FATAL_ERROR      .problem { border: 1px dotted #800; background: #fee }

      center.failure             { font-style: italic; font-size: 150% }

      .result .type { float: right }
      .result {
        font-family: monospace;
        white-space: pre;
        border-left: 6px solid #888;
        padding-left: 4px;
        margin: 2px
      }
      #caja-stack { white-space: pre; font-family: monospace }
    </style>

    <script type="text/javascript" src="caja.js"></script>
    <script type="text/javascript" src="caja-debugmode.js"></script>
    <script type="text/javascript" src="unicode.js"></script>
    <script type="text/javascript" src="html4-defs.js"></script>
    <script type="text/javascript" src="html-sanitizer.js"></script>
    <script type="text/javascript" src="html-emitter.js"></script>
    <script type="text/javascript" src="domita.js"></script>

    <link href=
     "http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.css"
     type="text/css" rel="stylesheet" />

    <script src=
     "http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.js"
     type="text/javascript"></script>

    <script type="text/javascript">
    function escapeHtml(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;')
          .replace(/>/g, '&gt;').replace(/\042/g, '&quot;');
    }
    
    function getCajoler() {
      return document.applets.cajoler;
    }
    
    function cajole() {
      var inputs = document.forms.cajolerForm.elements;
      var result = getCajoler().cajole(
          inputs.src.value.replace(/^\s+|\s+$/g, ''),
          Boolean(inputs.embeddable.checked),
          Boolean(inputs.debugSymbols.checked));
      var cajoledOutput = result[0];
      var messages = String(result[1]);
    
      if (cajoledOutput !== null) {
        cajoledOutput = String(cajoledOutput);
        document.getElementById('output').innerHTML
            = prettyPrintOne(escapeHtml(cajoledOutput));
    
        loadCaja(cajoledOutput);
      } else {
        document.getElementById('output').innerHTML
            = '<center class="failure">Failed<\/center>';
      }
      document.getElementById('messages').innerHTML = messages || '';
    }
    
    function innerText(node) {
      var s = [];
      innerTextHelper(node, s);
      return s.join();
    }
    
    function innerTextHelper(node, buf) {
      for (var child = node.firstChild; child; child = child.nextSibling) {
        if (child.nodeType === 3) {
          buf.push(child.nodeValue);
        } else {
          innerTextHelper(child, buf);
        }
      }
    }

    var testImports;

    function loadCaja(htmlText) {
      var m = htmlText.match(
          /^\s*<script[^\076]*>([\s\S]*?)<\/script[^\076]*>/i);
      if (m) {
        var script = m[1];

        testImports.clearHtml___();
        document.getElementById('caja-stacks').style.display = 'none';
        try {
          eval(script);
        } catch (ex) {
          var cajaStack = ex.cajaStack___
              && ___.unsealCallerStack(ex.cajaStack___);
          if (cajaStack) {
            document.getElementById('caja-stacks').style.display = '';
            document.getElementById('caja-stack').appendChild(
                document.createTextNode(cajaStack.join('\n')));
          }
          throw ex;
        }
      } else {
        (typeof console !== 'undefined')
        && console.warn('Failed to eval cajoled output %s', html);
      }
    }

    (function () {
      testImports = ___.copy(___.sharedImports);
      testImports.caja.result = ___.primFreeze(___.simpleFunc(function (o) {
        var type = document.createElement('span');
        type.className = 'type';
        type.appendChild(document.createTextNode(typeString(o)));

        var entry = document.createElement('div');
        entry.className = 'result';
        entry.appendChild(type);
        entry.appendChild(document.createTextNode(repr(o)));

        document.getElementById('eval-results').appendChild(entry);
      }));

      function typeString(o) {
        if (typeof o === 'object') {
          if (o === null) { return 'null'; }
          var ctor = ___.directConstructor(o);
          var name;
          if (ctor) {
            name = ctor.NAME___;
            if (!name && ('name' in ctor) && !___.hasOwnProp(ctor, 'name')) {
              name = ctor.name;
            }
            if (name) { return String(name); }
          }
        }
        return typeof o;
      }

      // Escape one character by javascript string literal rules
      function escapeOne(ch) {
        var i = ch.charCodeAt(0);
        if (i < 0x80) {
          switch (i) {
            case 9: return '\t';
            case 0x0a: return '\\n';
            case 0x0d: return '\\r';
            case 0x22: return '\\"';
            case 0x5c: return '\\\\';
            default: return (i < 0x10 ? '\\x0' : '\\x') + i.toString(16);
          }
        }
        var hex = i.toString(16);
        while (hex.length < 4) { hex = '0' + hex; }
        return '\\u' + hex;
      }

      // Builds part of the repr of a JSON map.
      function reprKeyValuePair(els) {
        return ___.simpleFunc(function (k, v) {
          els.push(repr(k) + ': ' + repr(v));
        });
      }

      // Like the python function, but produces a debugging string instead of
      // one that can be evaled.
      function repr(o) {
        switch (typeof o) {
          case 'string':
            return ('"'
                    + o.replace(/[^\x20\x21\x23-\x5b\x5d-\x7f]/g, escapeOne)
                    + '"');
          case 'object': case 'function':
            if (o === null) { break; }
            if (caja.isJSONContainer(o)) {
              var els = [];
              if ('length' in o
                  && !(Object.prototype.propertyIsEnumerable.call(o, 'length'))
                  ) {
                for (var i = 0; i < o.length; ++i) {
                  els.push(repr(o[i]));
                }
                return '[' + els.join(', ') + ']';
              } else {
                caja.each(o, reprKeyValuePair(els));
                return els.length ? '{ ' + els.join(', ') + ' }' : '{}';
              }
            }
            return '\u00ab' + o + '\u00bb';
        }
        return String(o);
      }

      ___.getNewModuleHandler().setImports(testImports);
      attachDocumentStub(
           '-xyz___',
           {
             rewrite:
                 function (uri, mimeType) {
                   if (!/^https?:\/\//i.test(uri)) { return null; }
                   return 'http://gadget-proxy/?url=' + encodeURIComponent(uri)
                       + '&mimeType=' + encodeURIComponent(mimeType);
                 }
           },
           testImports);
      testImports.clearHtml___ = function () {
        document.getElementById('caja-html').innerHTML = (
            '<center style="color: gray">eval<\/center>');
        testImports.htmlEmitter___ = new HtmlEmitter(
            document.getElementById('caja-html'));
      };
      /**
       * Put styles inside a node that is cleared for each gadget so that
       * styles don't persist across invocations of cajole.
       */
      testImports.getCssContainer___ = function () {
        return document.getElementById('caja-html');
      };
    })();
    </script>
  </head>

  <body bgcolor="white"
   onload="document.forms.cajolerForm.elements.src.select();
           testImports.clearHtml___()">
    <applet code="com.google.caja.opensocial.applet.CajaApplet" name="cajoler"
     archive="testbed.jar,
              ../../third_party/java/htmlparser/htmlparser.jar,
              ../../third_party/java/json_simple/json_simple.jar"
     codebase="." height="1" width="1" scriptable="true" MAYSCRIPT>
    </applet>

    <h1>Caja Test Bed <small><script>
      document.write(' : ' + getCajoler().getVersion());
    </script></small></h1>

    <p>
      <a href="http://code.google.com/p/google-caja/issues/entry"
       target="_blank">File a bug</a>
      <span id="instrlink">
        |
        <a href="javascript:void(
          document.getElementById('instrs').style.display='',
          document.getElementById('instrlink').style.display='none')"
         title="Show Instructions">Instructions</a>
      </span>
    </p>
    <div style="display:none" id="instrs">
      <p>
      Enter HTML into the textarea.  Contents of <code>&lt;style&gt;</code> and
      <code>&lt;script&gt;</code> elements are extracted.  The rest is treated
      as HTML and emitted normally.

      <p>
      Any Cajoler warnings are displayed in the top section.

      <p>
      The script and styles are rewritten and the rewritten gadget is displayed
      in pretty printed form in the middle section to the right.

      <p>
      The last expression in the program is logged in the bottom section, and
      emitted HTML is displayed below that.

      <p>Example:
      <pre class=prettyprint style="cursor: pointer"
       onclick="document.forms.cajolerForm.src.value = innerText(this)">
      &lt;!-- Styles are displayed --&gt;
      &lt;style&gt; p { color: purple } &lt;/style&gt;

      &lt;!-- Scripts are executed --&gt;
      &lt;script&gt;
        2 + 2  // You should see a missing semicolon warning too!
      &lt;/script&gt;

      &lt;!-- Regular HTML is emitted --&gt;
      &lt;p&gt;Hello World&lt;/p&gt;</pre>
    </div>

    <table cols="2"><tr valign="top">
    <td>
      <button onclick="cajole()">Cajole</button>
      <form name="cajolerForm" onsubmit="return false">
        &nbsp;
        <input name="embeddable" type="checkbox">
        <label for="embeddable" title="Output can be embedded in HTML/XML"
         >Embeddable</label>
        &nbsp;
        <input name="debugSymbols" type="checkbox">
        <label for="debugSymbols" title="Build with debugging symbols"
         >Debug Symbols</label>
        <br>
        <textarea cols="81" rows="40" name="src"
>&lt;script type="text/javascript"&gt;

&lt;/script&gt;
</textarea>
      </form>
      <br>
      <button onclick="cajole()">Cajole</button>
    <td>
      <pre id="messages" class="prettyprint"></pre>
      <hr>
      <pre id="output"></pre>
      <hr>

      <div id="eval-results"></div>
      <div id="caja-stacks" style="display:none">
        <hr>
        Errors
        <div id="caja-stack"></div>
      </div>
      <hr>
      <div id="caja-html" class="xyz___"></div>

    </table>

  </body>
</html>
